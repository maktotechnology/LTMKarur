@model IEnumerable<LTMKarur.Models.CountMaster>
@{
    ViewData["Title"] = "Count Master";
    Layout = "_Layout";
    var uoms = ViewBag.UOMOptions as List<string>;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

<div class="container-fluid mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Count Master</h5>
            <button id="addRow" class="btn btn-light btn-sm text-primary">+ Add New Row</button>
        </div>

        <div class="card-body">
            <table class="table table-bordered table-striped align-middle text-center" id="countGrid">
                <thead class="table-light">
                    <tr>
                        <th style="width:5%">ID</th>
                        <th style="width:25%">Count Name</th>
                        <th style="width:35%">Description</th>
                        <th style="width:15%">UOM</th>
                        <th style="width:20%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr data-id="@item.Id">
                            <td>@item.Id</td>
                            <td class="countName">@item.CountName</td>
                            <td class="description">@item.Description</td>
                            <td class="uom">@item.UOM</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary editBtn">Edit</button>
                                <button class="btn btn-sm btn-success saveBtn d-none">Save</button>
                                <button class="btn btn-sm btn-secondary cancelBtn d-none">Cancel</button>
                                <button class="btn btn-sm btn-danger deleteBtn">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
$(document).ready(function () {
    @using System.Text.Json
    const uomOptions = @Html.Raw(JsonSerializer.Serialize(uoms));
    // Edit mode
    $('#countGrid').on('click', '.editBtn', function () {
        const row = $(this).closest('tr');
        const countName = row.find('.countName').text().trim();
        const description = row.find('.description').text().trim();
        const uom = row.find('.uom').text().trim();

        // Build dropdown HTML dynamically
        let uomDropdown = `<select class="form-select form-select-sm">`;
        uomOptions.forEach(opt => {
            const selected = opt === uom ? 'selected' : '';
            uomDropdown += `<option ${selected}>${opt}</option>`;
        });
        uomDropdown += `</select>`;

        row.find('.countName').html(`<input type="text" class="form-control form-control-sm" value="${countName}">`);
        row.find('.description').html(`<input type="text" class="form-control form-control-sm" value="${description}">`);
        row.find('.uom').html(uomDropdown);

        row.find('.editBtn, .deleteBtn').addClass('d-none');
        row.find('.saveBtn, .cancelBtn').removeClass('d-none');
    });

    // Cancel edit
    $('#countGrid').on('click', '.cancelBtn', function () {
        location.reload();
    });

    // Save row
    $('#countGrid').on('click', '.saveBtn', function () {
        const row = $(this).closest('tr');
        const inputs = row.find('input, select');
        const data = {
            Id: parseInt(row.attr('data-id')) || 0,
            CountName: inputs.eq(0).val(),
            Description: inputs.eq(1).val(),
            UOM: inputs.eq(2).val()
        };

        $.ajax({
            url: '/CountMaster/Save',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                row.attr('data-id', res.id);
                row.html(`
                    <td>${res.id}</td>
                    <td class="countName">${data.CountName}</td>
                    <td class="description">${data.Description}</td>
                    <td class="uom">${data.UOM}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary editBtn">Edit</button>
                        <button class="btn btn-sm btn-success saveBtn d-none">Save</button>
                        <button class="btn btn-sm btn-secondary cancelBtn d-none">Cancel</button>
                        <button class="btn btn-sm btn-danger deleteBtn">Delete</button>
                    </td>
                `);
                row.css('background-color', '#d4edda');
                setTimeout(() => row.css('background-color', ''), 800);
            },
            error: function () {
                alert('❌ Error saving record.');
            }
        });
    });

    // Delete row
    $('#countGrid').on('click', '.deleteBtn', function () {
        const row = $(this).closest('tr');
        const id = parseInt(row.attr('data-id'));
        if (id === 0) { row.remove(); return; }

        if (!confirm('Delete this record?')) return;

        $.ajax({
            url: '/CountMaster/Delete',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(id),
            success: function () { row.remove(); },
            error: function () { alert('❌ Error deleting record.'); }
        });
    });

    // Add new row
    $('#addRow').click(function () {
        let dropdown = `<select class="form-select form-select-sm">`;
        uomOptions.forEach(opt => { dropdown += `<option>${opt}</option>`; });
        dropdown += `</select>`;

        const newRow = `
            <tr data-id="0" class="table-warning">
                <td>0</td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Count Name"></td>
                <td><input type="text" class="form-control form-control-sm" placeholder="Description"></td>
                <td>${dropdown}</td>
                <td>
                    <button class="btn btn-sm btn-success saveBtn">Save</button>
                    <button class="btn btn-sm btn-secondary cancelBtn">Cancel</button>
                    <button class="btn btn-sm btn-danger deleteBtn">Delete</button>
                </td>
            </tr>`;
        $('#countGrid tbody').append(newRow);
    });
});
</script>
}
